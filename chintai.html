<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex"/>
    <title>賃貸比較ノート - My Room Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
   
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-beige': '#fcfbf9',
                        'brand-sand': '#eaddcf',
                        'brand-blue': '#476a85',
                        'brand-blue-light': '#8faabf',
                        'brand-accent': '#d4a373',
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #fcfbf9;
            color: #4a4a4a;
            min-height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1586023492125-27b2c045efd7?q=80&w=2600&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
       
        .bg-overlay {
            background: rgba(252, 251, 249, 0.92);
            backdrop-filter: blur(4px);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .card { transition: all 0.3s ease; background: rgba(255, 255, 255, 0.95); }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(71, 106, 133, 0.15); }
       
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
       
        /* 入力フォーム */
        .input-group label { font-size: 13px; font-weight: 700; color: #8faabf; display: block; margin-bottom: 6px; letter-spacing: 0.05em; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%; padding: 10px 14px; border: 2px solid #f0eee9; border-radius: 10px;
            font-size: 15px; outline: none; transition: all 0.2s; background: #fff; color: #476a85;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            border-color: #8faabf; box-shadow: 0 0 0 3px rgba(143, 170, 191, 0.1);
        }

        /* チェックボックス */
        .checkbox-group label { display: flex; align-items: center; font-weight: 500; color: #555; font-size: 13px; cursor: pointer; padding: 6px 0; }
        .checkbox-group input[type="checkbox"] {
            appearance: none; width: 18px; height: 18px; border: 2px solid #cbd5e1; border-radius: 4px; margin-right: 8px; cursor: pointer; position: relative; background: white; flex-shrink: 0;
        }
        .checkbox-group input[type="checkbox"]:checked { background-color: #476a85; border-color: #476a85; }
        .checkbox-group input[type="checkbox"]:checked::after { content: '✓'; position: absolute; color: white; font-size: 12px; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* スクロールバー */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="bg-overlay">

        <!-- ヘッダー -->
        <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-30 border-b border-brand-sand/30">
            <div class="max-w-6xl mx-auto px-4 md:px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-brand-blue text-white w-9 h-9 rounded-full flex items-center justify-center shadow-md"><i class="fas fa-couch text-sm"></i></div>
                    <div>
                        <h1 class="font-bold text-lg text-brand-blue tracking-wide">賃貸比較ノート</h1>
                        <p class="text-[10px] text-brand-blue-light font-medium">My Room Plan</p>
                    </div>
                </div>
               
                <div class="flex items-center gap-2">
                    <div class="bg-brand-beige border border-brand-sand rounded-full p-1 flex shadow-inner">
                        <button onclick="switchView('list')" id="btn-list" class="bg-brand-blue text-white px-4 py-1.5 rounded-full text-xs font-bold transition shadow-sm flex items-center"><i class="fas fa-list mr-1"></i>一覧</button>
                        <button onclick="switchView('compare')" id="btn-compare" class="text-brand-blue-light px-4 py-1.5 rounded-full text-xs font-bold transition hover:text-brand-blue hover:bg-white/50 flex items-center"><i class="fas fa-table mr-1"></i>比較</button>
                    </div>
                    <!-- データ管理ボタン -->
                    <div class="hidden sm:flex ml-2 border-l border-brand-sand/30 pl-2 gap-1">
                        <button onclick="exportData()" class="text-brand-blue-light hover:text-brand-blue w-8 h-8 flex items-center justify-center transition" title="保存"><i class="fas fa-download"></i></button>
                        <button onclick="document.getElementById('importFile').click()" class="text-brand-blue-light hover:text-brand-blue w-8 h-8 flex items-center justify-center transition" title="読込"><i class="fas fa-upload"></i></button>
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                    </div>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="max-w-6xl mx-auto p-4 md:p-6 w-full flex-1">

            <!-- 新規登録ボタン -->
            <div class="mb-8 fade-in">
                <button onclick="openModal()" class="w-full bg-white border-2 border-dashed border-brand-blue-light/30 text-brand-blue-light hover:text-brand-blue hover:border-brand-blue/50 hover:bg-brand-blue/5 font-bold py-4 rounded-xl transition flex items-center justify-center gap-2 group">
                    <span class="bg-brand-blue/10 rounded-full w-8 h-8 flex items-center justify-center group-hover:bg-brand-blue/20 transition"><i class="fas fa-plus text-brand-blue"></i></span>
                    <span class="text-lg">新しい物件を登録する</span>
                </button>
            </div>

            <!-- リストビュー -->
            <div id="listView" class="fade-in">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h2 class="text-lg font-bold text-brand-blue flex items-center">
                        <i class="fas fa-bookmark text-brand-accent mr-2"></i>検討リスト <span id="countBadge" class="ml-2 bg-brand-sand/50 text-brand-blue px-2 py-0.5 rounded text-xs font-bold border border-brand-sand">0件</span>
                    </h2>
                    <button onclick="clearAllData()" class="text-xs text-brand-blue-light hover:text-red-400 transition flex items-center gap-1 px-3 py-1 rounded hover:bg-red-50"><i class="fas fa-trash-alt"></i> 全削除</button>
                </div>
                <div id="propertyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- 比較表ビュー -->
            <div id="compareView" class="hidden fade-in">
                <h2 class="text-lg font-bold text-brand-blue mb-4 px-2 flex items-center"><i class="fas fa-balance-scale-right text-brand-accent mr-2"></i>詳細比較</h2>
                <div class="bg-white/90 rounded-2xl shadow-lg border border-white overflow-hidden backdrop-blur-sm">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-brand-beige text-brand-blue border-b border-brand-sand/50">
                                <tr id="compareHeader">
                                    <th class="p-4 bg-brand-beige border-r border-brand-sand/50 sticky left-0 z-20 w-32 font-bold text-xs uppercase tracking-wider shadow-[2px_0_8px_-2px_rgba(0,0,0,0.05)] text-brand-blue-light">項目</th>
                                </tr>
                            </thead>
                            <tbody id="compareBody" class="divide-y divide-brand-sand/30 text-slate-600"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center py-6 text-xs text-brand-blue-light/60">&copy; Rental Note / Local Storage App</footer>
    </div>

    <!-- モーダル -->
    <div id="modal" class="fixed inset-0 bg-brand-blue/40 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full sm:max-w-2xl rounded-t-3xl sm:rounded-3xl shadow-2xl h-[95vh] sm:h-auto sm:max-h-[90vh] flex flex-col animate-slide-up border border-brand-sand">
           
            <div class="p-5 border-b border-brand-sand/30 flex justify-between items-center bg-brand-beige rounded-t-3xl sticky top-0 z-10">
                <h3 class="font-bold text-lg text-brand-blue flex items-center gap-2" id="modalTitle"><i class="fas fa-pen text-brand-sand"></i> 物件登録</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white border border-brand-sand/50 text-brand-blue-light hover:bg-brand-sand/30 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 bg-white custom-scrollbar">
                <input type="hidden" id="editId">
               
                <!-- 基本情報エリア (家賃・初期費用) -->
                <div class="bg-brand-beige/50 p-5 rounded-2xl border border-brand-sand/30 mb-6">
                    <div class="input-group mb-4">
                        <label>物件名 <span class="text-red-400 text-xs ml-1">*</span></label>
                        <input type="text" id="name" placeholder="例: メゾン青空 201" class="font-bold text-lg text-brand-blue border-brand-sand/50">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="input-group"><label>家賃 (万円)</label><input type="number" step="0.1" id="rent" placeholder="0.0"></div>
                        <div class="input-group"><label>管理費 (円)</label><input type="number" id="adminFee" placeholder="0"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group"><label>敷金 (ヶ月)</label>
                            <select id="deposit">
                                <option value="-">-</option><option value="0">0</option><option value="0.5">0.5</option><option value="1">1</option><option value="1.5">1.5</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                        <div class="input-group"><label>礼金 (ヶ月)</label>
                            <select id="keyMoney">
                                <option value="-">-</option><option value="0">0</option><option value="0.5">0.5</option><option value="1">1</option><option value="1.5">1.5</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 詳細スペック (並び順変更) -->
                <h4 class="text-xs font-bold text-brand-blue-light uppercase mb-3 px-1">基本データ</h4>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                    <div class="input-group"><label>構造</label>
                        <select id="structure">
                            <option value="">選択</option>
                            <option value="鉄筋系">鉄筋系</option>
                            <option value="鉄骨系">鉄骨系</option>
                            <option value="木造">木造</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    <div class="input-group"><label>階数 (階)</label><input type="number" id="floor" placeholder="2"></div>
                    <div class="input-group"><label>方位</label>
                        <select id="direction">
                            <option value="">選択</option>
                            <option value="北">北</option><option value="北東">北東</option><option value="東">東</option><option value="南東">南東</option>
                            <option value="南">南</option><option value="南西">南西</option><option value="西">西</option><option value="北西">北西</option>
                        </select>
                    </div>
                    <div class="input-group"><label>最寄駅</label><input type="text" id="station" placeholder="新宿駅"></div>
                    <div class="input-group"><label>駅徒歩 (分)</label><input type="number" min="0" id="walk" placeholder="5"></div>
                   
                    <div class="input-group">
                        <label>間取り</label>
                        <select id="layout">
                            <option value="">選択</option>
                            <option value="1R">1R</option> <option value="1K">1K</option> <option value="1DK">1DK</option> <option value="1LDK">1LDK</option>
                            <option value="2K">2K</option> <option value="2DK">2DK</option> <option value="2LDK">2LDK</option>
                            <option value="3K">3K</option> <option value="3DK">3DK</option> <option value="3LDK">3LDK</option>
                            <option value="4K以上">4K以上</option>
                        </select>
                    </div>
                    <div class="input-group"><label>広さ (㎡)</label><input type="number" step="0.01" id="size" placeholder="25.0"></div>
                    <div class="input-group"><label>築年数 (年)</label><input type="text" id="age" placeholder="10"></div>
                </div>

                <!-- 設備 -->
                <h4 class="text-xs font-bold text-brand-blue-light uppercase mb-3 px-1">設備・条件</h4>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6 checkbox-group grid grid-cols-2 gap-3">
                    <label><input type="checkbox" name="feature" value="駅徒歩10分以内"> 駅徒歩10分以内</label>
                    <label><input type="checkbox" name="feature" value="2階以上"> 2階以上</label>
                    <label><input type="checkbox" name="feature" value="バストイレ別"> バストイレ別</label>
                    <label><input type="checkbox" name="feature" value="追炊機能"> 追炊機能</label>
                    <label><input type="checkbox" name="feature" value="浴室乾燥"> 浴室乾燥</label>
                    <label><input type="checkbox" name="feature" value="洗面所独立"> 洗面所独立</label>
                    <label><input type="checkbox" name="feature" value="二口コンロ以上"> 二口コンロ以上</label>
                    <label><input type="checkbox" name="feature" value="IHコンロ"> IHコンロ</label>
                    <label><input type="checkbox" name="feature" value="オートロック"> オートロック</label>
                    <label><input type="checkbox" name="feature" value="シューズボックス"> シューズボックス</label>
                    <label><input type="checkbox" name="feature" value="宅配ボックス"> 宅配ボックス</label>
                    <label><input type="checkbox" name="feature" value="クローゼット"> クローゼット</label>
                    <label><input type="checkbox" name="feature" value="都市ガス"> 都市ガス</label>
                    <label><input type="checkbox" name="feature" value="24時間ゴミ出し可"> 24時間ゴミ出し可</label>
                </div>

                <!-- その他 -->
                <div class="space-y-4">
                    <div class="input-group"><label>備考欄</label><textarea id="memo" rows="3" class="bg-brand-beige border-brand-sand/50"></textarea></div>
                    <div class="input-group"><label>物件URL</label><input type="text" id="url" class="text-xs"></div>
                </div>
            </div>

            <div class="p-5 border-t border-brand-sand/30 bg-brand-beige rounded-b-3xl flex gap-3">
                <button onclick="deleteProp()" id="btnDelete" class="px-5 py-3 text-red-400 font-bold text-sm bg-white border border-red-100 rounded-xl hover:bg-red-50 transition hidden"><i class="fas fa-trash-alt"></i></button>
                <button onclick="saveData()" class="flex-1 py-3 bg-brand-blue text-white font-bold rounded-xl shadow-lg hover:bg-[#355269] transform active:scale-95 transition text-base">保存する</button>
            </div>
        </div>
    </div>

    <script>
        // データキー: v5
        const STORAGE_KEY = 'rental_local_v5';
        let properties = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

        // 数値フォーマット (3桁区切り)
        function formatNum(num) {
            return num ? Number(num).toLocaleString() : '-';
        }

        // 描画処理
        function render() {
            const grid = document.getElementById('propertyGrid');
            const compHeader = document.getElementById('compareHeader');
            const compBody = document.getElementById('compareBody');
           
            document.getElementById('countBadge').textContent = properties.length + '件';
            grid.innerHTML = '';
            while(compHeader.children.length > 1) compHeader.removeChild(compHeader.lastChild);
            compBody.innerHTML = '';

            if(properties.length === 0) {
                grid.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-20"><p class="text-brand-blue font-bold">物件が登録されていません</p></div>`;
                return;
            }

            // 比較項目 (順序変更)
            const items = [
                {k:'rent', l:'家賃', u:'万'}, {k:'adminFee', l:'管理費', u:'円', fmt: true},
                {k:'totalCost', l:'月額合計', u:'円', fmt: true},
                {k:'initial_cost', l:'敷/礼', u:''},
                {k:'structure', l:'構造'}, {k:'floor', l:'階数', u:'階'},
                {k:'direction', l:'方位'}, {k:'station', l:'最寄駅'}, {k:'walk', l:'駅徒歩', u:'分'},
                {k:'layout', l:'間取り'}, {k:'size', l:'広さ', u:'㎡'},
                {k:'age_display', l:'築年数'}, // 表示用キー
                {k:'features', l:'設備'}, {k:'memo', l:'備考'}
            ];

            // 比較表の行作成 (修正: 変数宣言漏れの修正)
            const trs = {};
            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-brand-sand/10 transition";
                tr.innerHTML = `<td class="p-4 border-r border-brand-sand/50 sticky left-0 bg-brand-beige font-bold text-xs text-brand-blue-light shadow-[2px_0_8px_-2px_rgba(0,0,0,0.05)]">${item.l}</td>`;
                trs[item.k] = tr;
                compBody.appendChild(tr);
            });

            // カードと比較表の生成
            properties.forEach(p => {
                // データ加工 (表示用)
                const rentVal = p.rent ? parseFloat(p.rent) : 0;
                const adminVal = p.adminFee ? parseInt(p.adminFee) : 0;
                const totalMonth = (rentVal * 10000) + adminVal;
               
                p.totalCost = totalMonth; // 比較表用
                p.age_display = p.age ? `築${p.age}年` : '-'; // 築年数表示用
                p.initial_cost = `${p.deposit || '-'} / ${p.keyMoney || '-'}`; // 敷/礼

                // カード
                const card = document.createElement('div');
                card.className = 'card bg-white rounded-2xl border border-white shadow-sm cursor-pointer flex flex-col h-full relative group overflow-hidden';
                card.onclick = (e) => { if(!e.target.closest('a')) openModal(p.id); };
               
                const featureTags = p.features && Array.isArray(p.features)
                    ? p.features.slice(0, 3).map(f => `<span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded text-[10px] border border-slate-200">${f}</span>`).join('')
                    : '';

                card.innerHTML = `
                    <div class="h-2 bg-brand-blue w-full"></div>
                    <div class="p-6 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-4 gap-3">
                            <h3 class="font-bold text-brand-blue text-lg line-clamp-2 leading-snug group-hover:text-[#355269] transition">${p.name}</h3>
                            ${p.layout ? `<span class="bg-brand-beige text-brand-blue text-[11px] px-3 py-1 rounded-lg font-bold whitespace-nowrap border border-brand-sand">${p.layout}</span>` : ''}
                        </div>
                        <div class="mb-4 pb-4 border-b border-brand-sand/30">
                            <div class="flex items-baseline">
                                <div class="text-3xl font-bold text-brand-blue font-sans">${p.rent || '-'}<span class="text-sm text-brand-blue-light ml-1 font-medium">万円</span></div>
                                <div class="text-xs text-brand-blue-light ml-3">管理費: ${formatNum(p.adminFee)}円</div>
                            </div>
                            <div class="text-xs font-bold text-brand-accent mt-1 text-right">月額計: ${formatNum(totalMonth)}円</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs text-brand-blue/80 mb-4">
                            <div class="flex items-center gap-2"><i class="fas fa-train text-brand-accent"></i><span class="truncate">${p.station || '-'}</span></div>
                            <div class="flex items-center gap-2"><i class="fas fa-walking text-brand-accent"></i>${p.walk ? p.walk+'分' : '-'}</div>
                            <div class="flex items-center gap-2"><i class="fas fa-expand text-brand-accent"></i>${p.size ? p.size+'㎡' : '-'}</div>
                            <div class="flex items-center gap-2"><i class="fas fa-layer-group text-brand-accent"></i>${p.floor ? p.floor+'階' : '-'}</div>
                        </div>
                        ${featureTags ? `<div class="flex flex-wrap gap-1 mb-4">${featureTags}</div>` : ''}
                        <div class="mt-5 pt-4 border-t border-brand-sand/30 flex justify-between items-center">
                            ${p.url ? `<a href="${p.url}" target="_blank" class="text-xs text-brand-blue font-bold hover:underline bg-brand-sand/20 px-3 py-1.5 rounded-full hover:bg-brand-sand/40 transition"><i class="fas fa-external-link-alt mr-1"></i> サイト</a>` : '<span class="text-xs text-brand-sand">URLなし</span>'}
                            <span class="text-xs text-brand-blue-light group-hover:text-brand-blue transition font-bold flex items-center">編集 <i class="fas fa-pen ml-1 text-[10px]"></i></span>
                        </div>
                    </div>`;
                grid.appendChild(card);

                // 比較表列
                const th = document.createElement('th');
                th.className = 'p-5 font-medium text-brand-blue min-w-[180px] border-l border-brand-sand/30 align-top bg-white/50';
                th.innerHTML = `<div class="flex flex-col h-full justify-between gap-3"><div class="line-clamp-2 text-xs mb-1 font-bold leading-relaxed">${p.name}</div><button onclick="openModal(${p.id})" class="text-[10px] bg-white border border-brand-sand px-3 py-1.5 rounded-lg text-brand-blue-light hover:bg-brand-blue hover:text-white transition">編集</button></div>`;
                compHeader.appendChild(th);

                items.forEach(item => {
                    const td = document.createElement('td');
                    td.className = 'p-4 border-l border-brand-sand/30 text-center text-sm bg-white/30 text-brand-blue';
                   
                    let val = p[item.k];
                    if (val === undefined || val === null || val === '') val = '-';
                    else if (item.fmt) val = formatNum(val);

                    if(item.k === 'memo') {
                        td.className += ' text-left whitespace-normal min-w-[220px] text-xs text-brand-blue/70 align-top leading-relaxed';
                        td.innerHTML = `<div class="max-h-24 overflow-y-auto pr-2">${val}</div>`;
                    } else if (item.k === 'features') {
                        td.className += ' text-left align-top min-w-[150px]';
                        if (Array.isArray(val) && val.length > 0) {
                            td.innerHTML = val.map(f => `<div class="text-xs mb-1 text-brand-blue-light"><i class="fas fa-check text-brand-accent mr-1"></i>${f}</div>`).join('');
                        } else { td.textContent = '-'; }
                    } else if (item.k === 'initial_cost') {
                         td.textContent = (val === '- / -') ? '-' : val + 'ヶ月';
                    } else {
                        if(val !== '-' && item.u) val += item.u;
                        td.textContent = val;
                        if(item.k === 'rent' || item.k === 'totalCost') td.className += ' font-bold';
                    }
                    trs[item.k].appendChild(td);
                });
            });
        }

        // --- モーダル操作 ---
        function openModal(id = null) {
            const modal = document.getElementById('modal');
            const btnDelete = document.getElementById('btnDelete');
            const title = document.getElementById('modalTitle');
            document.getElementById('editId').value = id ? id : 'new';
           
            // フィールドリセット
            const fields = ['name','rent','adminFee','layout','size','floor','station','walk','age','memo','url','deposit','keyMoney','structure','direction'];
            fields.forEach(f => {
                const el = document.getElementById(f);
                if(el) el.value = '';
            });
            document.querySelectorAll('input[name="feature"]').forEach(cb => cb.checked = false);
           
            if(id) {
                const p = properties.find(x => x.id === id);
                if (p) {
                    title.innerHTML = '<i class="fas fa-pen text-brand-sand"></i> 物件情報の編集';
                    btnDelete.classList.remove('hidden');
                    fields.forEach(f => {
                        const el = document.getElementById(f);
                        if(el) el.value = p[f] || '';
                    });
                    if (p.features && Array.isArray(p.features)) {
                        p.features.forEach(f => {
                            const cb = document.querySelector(`input[name="feature"][value="${f}"]`);
                            if(cb) cb.checked = true;
                        });
                    }
                }
            } else {
                title.innerHTML = '<i class="fas fa-plus text-brand-sand"></i> 新しい物件を登録';
                btnDelete.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveData() {
            try {
                const idVal = document.getElementById('editId').value;
                const name = document.getElementById('name').value;
                if(!name) return alert('物件名は必須です');

                const features = Array.from(document.querySelectorAll('input[name="feature"]:checked')).map(cb => cb.value);
               
                const data = {
                    name,
                    rent: document.getElementById('rent').value,
                    adminFee: document.getElementById('adminFee').value,
                    layout: document.getElementById('layout').value,
                    size: document.getElementById('size').value,
                    floor: document.getElementById('floor').value,
                    station: document.getElementById('station').value,
                    walk: document.getElementById('walk').value,
                    age: document.getElementById('age').value,
                    deposit: document.getElementById('deposit').value,
                    keyMoney: document.getElementById('keyMoney').value,
                    structure: document.getElementById('structure').value,
                    direction: document.getElementById('direction').value,
                    memo: document.getElementById('memo').value,
                    url: document.getElementById('url').value,
                    features: features
                };

                if (idVal === 'new') {
                    properties.push({id: Date.now(), ...data});
                } else {
                    const targetId = Number(idVal);
                    const idx = properties.findIndex(x => x.id === targetId);
                    if(idx > -1) {
                        properties[idx] = { ...properties[idx], ...data };
                    } else {
                        properties.push({id: Date.now(), ...data});
                    }
                }
               
                localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
                render();
                closeModal();
            } catch (error) {
                alert("保存エラー: " + error.message);
                console.error(error);
            }
        }

        function deleteProp() {
            const id = document.getElementById('editId').value;
            if(!id || id === 'new') return;
            if(confirm('本当に削除しますか？')) {
                properties = properties.filter(x => x.id != Number(id));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
                render();
                closeModal();
            }
        }

        function clearAllData() {
            if(properties.length > 0 && confirm('全てのデータを削除しますか？')) {
                properties = [];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
                render();
            }
        }

        // --- Import/Export ---
        function exportData() {
            if(properties.length===0) return alert('データがありません');
            const blob = new Blob([JSON.stringify(properties, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `my_room_plan_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(confirm("データを上書きして読み込みますか？")) {
                        properties = json;
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
                        render();
                    }
                } catch(e) { alert('ファイル形式エラー'); }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function switchView(mode) {
            const list = document.getElementById('listView');
            const comp = document.getElementById('compareView');
            const btnL = document.getElementById('btn-list');
            const btnC = document.getElementById('btn-compare');
           
            if(mode === 'list') {
                list.classList.remove('hidden'); comp.classList.add('hidden');
                btnL.classList.add('bg-brand-blue', 'text-white'); btnL.classList.remove('text-brand-blue-light', 'bg-transparent');
                btnC.classList.remove('bg-brand-blue', 'text-white'); btnC.classList.add('text-brand-blue-light');
            } else {
                list.classList.add('hidden'); comp.classList.remove('hidden');
                btnC.classList.add('bg-brand-blue', 'text-white'); btnC.classList.remove('text-brand-blue-light', 'bg-transparent');
                btnL.classList.remove('bg-brand-blue', 'text-white'); btnL.classList.add('text-brand-blue-light');
            }
        }

        render();
    </script>
</body>
</html>